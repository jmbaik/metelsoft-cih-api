<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="metel.cih.api.youtube.mapper.YoutubeMapper">

    <select id="selectYoutubePastor" resultType="metel.cih.api.dto.YoutubePastorDto" parameterType="hashmap">
        SELECT a.vid, a.p_code as pastorCode, c.name as pastorName, a.title, a.create_ymd as createYmd, a.grade, a.sort
            , b.channel_id as channelId, b.title as channelTitle, a.thumbnail_d as thumbnailDefault
            , a.thumbnail_m as thumbnailMedium, a.thumbnail_h as thumbnailHigh, a.regid as userId, a.upddt as updDt
        FROM tb_youtube_pastor a inner join tb_origin_vid b on a.channel_id = b.channel_id
        inner join tb_pastor c on a.p_code = c.p_code
        where 1=1
        <if test='pastorCode != null and pastorCode != ""'>
            AND a.p_code = #{pastorCode}
        </if>
        <if test='channelId != null and channelId != ""'>
            and a.channel_id = #{channelId}
        </if>
        order by a.upddt desc
    </select>
    <insert id="mergeYoutubePastor" parameterType="metel.cih.api.dto.YoutubePastorDto">
        INSERT INTO tb_youtube_pastor
        (vid, p_code, channel_id, title, channel_title, thumbnail_d, thumbnail_m, thumbnail_h
            , grade, sort, description, create_ymd, regid, regdt, updid, upddt)
        values ( #{vid}, #{pastorCode}, #{channelId}, #{title}, #{channelTitle}, #{thumbnailDefault}, #{thumbnailMedium}, #{thumbnailHigh}
            , #{grade}, #{sort}, #{description}, date_format(now(), '%Y%m%d'), #{userId}, now(), #{userId}, now())
        ON DUPLICATE KEY UPDATE p_code=#{pastorCode}, grade=#{grade}, sort=#{sort}
            , updid=#{userId}, upddt=current_timestamp()
    </insert>
    <update id="updateYoutubePastor" parameterType="metel.cih.api.dto.YoutubePastorDto">
        UPDATE tb_youtube_pastor
        SET p_code=#{pastorCode}, channel_id=#{channelId}, title=#{title}
            , channel_title=#{channelTitle}, thumbnail_d=#{thumbnailDefault}, thumbnail_m=#{thumbnailMedium}, thumbnail_h=#{thumbnailHigh}
            , grade=#{grade}, sort=#{sort}, description= #{description}
            , updid=#{userId}, upddt=current_timestamp()
        WHERE vid=#{vid}
    </update>
    <delete id="deleteYoutubePastor" parameterType="metel.cih.api.dto.YoutubePastorDto">
        DELETE FROM tb_youtube_pastor WHERE vid=#{vid}
    </delete>

    <select id="selectOriginVid" resultType="metel.cih.api.dto.OriginVidDto" parameterType="hashmap">
        SELECT channel_id as channelId, title as channelTitle, description as channelDescription, regid as userId, upddt as updDt
        FROM tb_origin_vid
        where 1=1
        <if test='channelTitle != null and channelTitle != ""'>
            and title like concat('%', #{channelTitle}, '%')
        </if>
        order by upddt desc
    </select>

    <insert id="mergeOriginVid" parameterType="metel.cih.api.dto.OriginVidDto">
        INSERT INTO tb_origin_vid
            (channel_id, title, description, regid, regdt, updid, upddt)
        values (#{channelId}, #{channelTitle}, #{channelDescription}, #{userId}, now(), #{userId}, now())
        ON DUPLICATE KEY UPDATE updid=#{userId}, upddt= now()
    </insert>
    <update id="updateOriginVid" parameterType="metel.cih.api.dto.OriginVidDto">
        UPDATE tb_origin_vid
        SET title=#{channelTitle}, description=#{channelDescription}, updid=#{userId}, upddt=now()
        WHERE channel_id=#{channelId}
    </update>
    <delete id="deleteOriginVid" parameterType="metel.cih.api.dto.OriginVidDto">
        DELETE FROM tb_origin_vid WHERE channel_id=#{channelId}
    </delete>
</mapper>